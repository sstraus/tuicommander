# Code Review: 863014c — Split Terminal Improvements

**Date:** 2026-02-17
**Reviewers:** Multi-Agent (security, performance, architecture, simplicity, silent-failure, test-quality, typescript, rust)
**Target:** Commit 863014c `feat: split terminal improvements — cleanup, sizing, menu, unified mode`
**Files Changed:** 19 (714 insertions, 29 deletions)
**Confidence Threshold:** 70

## Summary

- **P1 Critical Issues:** 5
- **P2 Important Issues:** 12
- **P3 Nice-to-Have:** 8
- **Filtered Out (below threshold):** 3

---

## P1 - Critical (Block Merge)

### 1. [SILENT-FAILURE] Rust config accepts invalid `split_tab_mode` values

**File:** `src-tauri/src/config.rs:30` | **Confidence:** 95 | **Agents:** silent-failure, rust, security, architecture

**Issue:** `split_tab_mode` is `String` instead of a Rust enum. Any string passes deserialization — `"banana"` is accepted silently. No validation, no error, wrong behavior at runtime.

**Fix:** Define `enum SplitTabMode { Separate, Unified }` with serde rename, use it as the field type. Invalid values will fail at deserialization time with a clear error.

---

### 2. [SILENT-FAILURE] Silent data loss on config save failure

**File:** `src/stores/settings.ts:setSplitTabMode` | **Confidence:** 95 | **Agents:** silent-failure, typescript

**Issue:** `setSplitTabMode` updates local state optimistically, then persists. If `save_config` fails, the UI shows the new value but it's lost on restart. No error shown to user.

**Fix:** Catch persist errors and either revert state or show a toast notification.

---

### 3. [SILENT-FAILURE] Silent fallback for unknown theme name

**File:** `src/themes.ts:applyAppTheme` | **Confidence:** 85 | **Agents:** silent-failure

**Issue:** `getAppTheme()` returns `APP_THEMES[name]` which is `undefined` for unknown names. `applyAppTheme` would iterate over `undefined` and silently do nothing — leaving stale CSS variables.

**Fix:** Add a fallback to default theme with `console.warn`, or throw.

---

### 4. [TEST-GAP] `useSplitPanes` unified mode branch-skip logic has zero test coverage

**File:** `src/hooks/useSplitPanes.ts:24-30` | **Confidence:** 90 | **Agent:** test-quality

**Issue:** The core unified mode logic that skips `addTerminalToBranch()` is completely untested. This is the feature's central mechanism.

**Fix:** Add tests for separate mode (terminal added to branch) vs unified mode (terminal NOT added to branch).

---

### 5. [TEST-GAP] Split collapse edge cases untested

**File:** `src/__tests__/hooks/useTerminalLifecycle.test.ts` | **Confidence:** 87 | **Agent:** test-quality

**Issue:** Only happy-path split collapse tested. Missing: closing terminal not in panes array, closing when panes is empty, closing when layout is already `"none"`.

**Fix:** Add boundary condition tests for split collapse logic.

---

## P2 - Important (Fix Before/After Merge)

### 6. [TYPE-SAFETY] Unchecked type assertion `as SplitTabMode`

**File:** `src/components/SettingsPanel/tabs/GeneralTab.tsx` | **Confidence:** 92 | **Agents:** typescript, security, silent-failure

**Issue:** `e.target.value as SplitTabMode` trusts DOM value without validation. If HTML is manipulated, invalid values enter the system.

**Fix:** Validate against known values before cast, or use a type guard.

---

### 7. [TYPE-SAFETY] Unchecked `splitIndex as 0 | 1` assertion

**File:** `src/hooks/useTerminalLifecycle.ts` | **Confidence:** 88 | **Agents:** typescript, silent-failure

**Issue:** `indexOf()` returns `-1` when not found, which passes the `!== -1` guard but `splitIndex as 0 | 1` could be any number if panes has 3+ entries.

**Fix:** Explicitly check `splitIndex === 0 || splitIndex === 1`.

---

### 8. [ARCHITECTURE] TabBar has excessive responsibility

**File:** `src/components/TabBar/TabBar.tsx` | **Confidence:** 95 | **Agent:** architecture

**Issue:** TabBar directly accesses 5 stores, manages two context menus, handles unified mode filtering, drag-and-drop, and rename editing. This is a god component.

**Fix:** Extract unified mode logic into a derived store or helper. Consider extracting menu logic.

---

### 9. [ARCHITECTURE] Split cleanup logic duplicated between hooks

**File:** `src/hooks/useTerminalLifecycle.ts` + `src/hooks/useKeyboardShortcuts.ts` | **Confidence:** 90 | **Agents:** architecture, simplicity

**Issue:** `closeTerminal()` has split collapse logic, and `useKeyboardShortcuts` previously had its own. The refactor delegates Cmd+W to `closeTerminal()`, but the close-both-panes logic in TabBar's unified mode duplicates collapse awareness.

**Fix:** Centralize all split-aware close logic in `closeTerminal()`.

---

### 10. [SIMPLICITY] Close-both-panes logic duplicated in TabBar

**File:** `src/components/TabBar/TabBar.tsx` (onClick + onAuxClick) | **Confidence:** 95 | **Agent:** simplicity

**Issue:** Both click and middle-click handlers on the unified tab close button have identical logic to close both panes.

**Fix:** Extract to a `closeUnifiedTab()` function.

---

### 11. [RUST] String instead of enum for `split_tab_mode`

**File:** `src-tauri/src/config.rs:30` | **Confidence:** 95 | **Agent:** rust

**(Duplicate of P1 #1 — counted once in P1)**

---

### 12. [RUST] Inconsistent pattern — `ErrorHandlingConfig.strategy` uses enum but `split_tab_mode` uses String

**File:** `src-tauri/src/config.rs` | **Confidence:** 80 | **Agent:** rust

**Issue:** Other config fields use proper enums. `split_tab_mode` breaks the pattern.

**Fix:** Align with existing pattern — use enum.

---

### 13. [PERF] Excessive signal computations in TabBar For loop

**File:** `src/components/TabBar/TabBar.tsx` (For loop) | **Confidence:** 88 | **Agents:** performance, simplicity, typescript

**Issue:** Six derived signals computed per tab inside `<For>` — `isActive`, `isSecondPane`, `isHiddenByUnified`, `displayName`, `isUnified`, `isDragging`. These recompute on every store change.

**Fix:** Consolidate into a single `createMemo` returning a tab metadata object.

---

### 14. [ARCHITECTURE] `useSplitPanes` conditionally accesses settingsStore

**File:** `src/hooks/useSplitPanes.ts` | **Confidence:** 88 | **Agent:** architecture

**Issue:** The hook conditionally reads `settingsStore.state.splitTabMode` deep inside the split logic. This creates an implicit dependency that's easy to miss.

**Fix:** Accept `splitTabMode` as parameter or read it at the top of the function.

---

### 15. [TEST-GAP] Missing negative test for `setSplitTabMode` with invalid value

**File:** `src/__tests__/stores/settings.test.ts` | **Confidence:** 90 | **Agent:** test-quality

**Fix:** Add test for invalid mode value and persist error handling.

---

### 16. [TEST-GAP] Missing test for split menu positioning

**File:** `src/__tests__/components/TabBar.test.tsx` | **Confidence:** 92 | **Agent:** test-quality

**Fix:** Verify `openAt()` receives correct coordinates from `getBoundingClientRect()`.

---

### 17. [TEST-GAP] Missing test for unified mode close cleanup

**File:** `src/__tests__/components/TabBar.test.tsx` | **Confidence:** 85 | **Agent:** test-quality

**Fix:** Verify layout state is cleaned up after unified close.

---

## P3 - Nice-to-Have

### 18. [SIMPLICITY] Manual CSS variable name mapping in `applyAppTheme`

**File:** `src/themes.ts` | **Confidence:** 85 | **Agent:** simplicity

**Issue:** Manual `CSS_VAR_MAP` mapping camelCase to kebab-case. Could derive programmatically.

---

### 19. [SIMPLICITY] Eight full theme definitions may be YAGNI

**File:** `src/themes.ts` | **Confidence:** 70 | **Agent:** simplicity

**Issue:** Eight complete theme objects added at once. Could start with 2-3 and add more later.

---

### 20. [RUST] Unnecessary String allocation in default

**File:** `src-tauri/src/config.rs` | **Confidence:** 90 | **Agent:** rust

**Issue:** `String::from("separate")` allocates on every default. Enum with `Default` derive avoids this.

---

### 21. [PERF] Race condition in rapid `setSplitTabMode` calls

**File:** `src/stores/settings.ts` | **Confidence:** 65 | **Agent:** performance

**Issue:** Rapid toggling could cause stale config reads.

---

### 22. [TEST] CSS variable mapping completeness test

**File:** `src/__tests__/themes.test.ts` | **Confidence:** 82 | **Agent:** test-quality

**Issue:** Test verifies 2 variables but not all 13.

---

### 23-25. Minor: ContextMenu `openAt` symmetry, theme application in presentation layer, store reset helper in tests

**Confidence:** 65-78 | **Agents:** simplicity, architecture, test-quality

---

## Cross-Cutting Analysis

### Root Causes Identified

| Root Cause | Findings Affected | Suggested Fix |
|------------|-------------------|---------------|
| `split_tab_mode` as String (no validation) | #1, #6, #7, #11, #12, #15, #20 | Define Rust enum `SplitTabMode` — fixes 7 findings at once |
| Optimistic update without error handling | #2, #15 | Add error handling pattern to all settings setters |
| Unified mode logic scattered across components | #4, #8, #9, #10, #14 | Centralize in a single hook or derived store |

### Single-Fix Opportunities

1. **Rust `SplitTabMode` enum** — Fixes findings #1, #11, #12, #20 (~15 lines of Rust). Cascade: TypeScript type guard becomes natural since values are constrained at source.

2. **`closeUnifiedTab()` extraction** — Fixes #9, #10 (~10 lines). Extract from TabBar onClick/auxClick.

3. **Tab metadata `createMemo`** — Fixes #13 (~20 lines). Single memo per tab instead of 6 signals.

### Context Files (Read Before Fixing)

| File | Reason | Referenced By |
|------|--------|---------------|
| `src/stores/terminals.ts` | Layout state, `setLayout()`, `splitPane()` | architecture, test-quality, silent-failure |
| `src/stores/repositories.ts` | `addTerminalToBranch()` for unified mode | test-quality, architecture |
| `src/stores/settings.ts` | Setter pattern, persist logic | typescript, silent-failure, test-quality |

---

## Recommended Actions

1. **Immediate (P1):** Rust enum for `split_tab_mode` + validation (fixes 7 findings)
2. **Immediate (P1):** Add `useSplitPanes` unified mode tests
3. **This PR:** Extract close-unified logic, consolidate tab signals
4. **Follow-up:** Settings persist error handling pattern
